<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSSê¸‰ ë¶“ íš¨ìœ¨ ê³„ì‚°ê¸° (ë‚´ì¥ 2ì°¨ì„±ì¥)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', system-ui, -apple-system, "Segoe UI", Arial, sans-serif; }
    .card-container { transition: all .2s ease; }
    .card-container:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .aspect-3-4 { aspect-ratio: 3/4; object-fit: cover; }
    .status-error { background:#fff1f2; color:#991b1b; border:1px solid #fecaca; padding:.5rem .75rem; border-radius:.5rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold">SSSê¸‰ ë¶“ íš¨ìœ¨ ê³„ì‚°ê¸°</h1>
      <p class="text-gray-600 mt-2">ì‹œíŠ¸ ì—†ì´, ì½”ë“œì— ë‚´ì¥ëœ <b>ì •í™• ì¬í˜„ 2ì°¨ì‹</b> ì„±ì¥ ë¡œì§ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
    </header>

    <!-- ì„¤ì • -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-3 border-b pb-2">ê¸°ë³¸ ì„¤ì •</h2>
      <div class="flex flex-col md:flex-row gap-4 md:items-end md:gap-6">
        <div>
          <label class="block text-sm mb-1" for="budget">ë³´ìœ  ë¶“ ê°œìˆ˜</label>
          <input id="budget" type="number" value="100000" class="w-40 p-2 border rounded-md">
        </div>
        <div class="flex gap-2">
          <button id="calcBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">ê³„ì‚° ì‹œì‘</button>
          <button id="resetBtn" class="bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>
      <p id="status" class="mt-3 text-sm text-gray-600">ì¹´ë“œë¥¼ í™œì„±í™”í•˜ê³  ë ˆë²¨/ê°ì„±ì„ ì„ íƒí•œ ë’¤ [ê³„ì‚° ì‹œì‘]ì„ ëˆ„ë¥´ì„¸ìš”.</p>
    </section>

    <!-- ì¹´ë“œ -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">ì¹´ë“œ ì •ë³´</h2>
        <span id="meta" class="text-xs px-2 py-1 border rounded text-gray-600">-</span>
      </div>
      <!-- ê°€ë¡œ 4ê°œ ê³ ì • -->
      <div id="card-list" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- ê²°ê³¼ -->
    <section id="result-section" class="bg-white p-6 rounded-xl shadow-md hidden">
      <h2 class="text-xl font-semibold mb-3 border-b pb-2">ê³„ì‚° ê²°ê³¼</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-2 text-indigo-700">ğŸ“ˆ ë ™ì—… ê³„íš</h3>
          <div id="plan-output" class="h-72 overflow-y-auto bg-gray-50 p-3 rounded-md border"></div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2 text-indigo-700">ğŸ“Š ìµœì¢… ìš”ì•½</h3>
          <div class="space-y-1 text-sm">
            <p><strong>- ì‚¬ìš©í•œ ë¶“:</strong> <span id="used-brush">0</span>ê°œ</p>
            <p><strong>- ë‚¨ì€ ë¶“:</strong> <span id="remaining-brush">0</span>ê°œ</p>
            <p><strong>- ì´ íš¨ìœ¨ ìƒìŠ¹:</strong> <span id="total-gain" class="font-bold text-green-600">0.00%</span></p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ì „ì—­ ì—ëŸ¬ë¥¼ ìƒíƒœì°½ì— í‘œì‹œ
    window.addEventListener('error', function(e){
      var st = document.getElementById('status');
      if (st) {
        st.classList.add('status-error');
        st.textContent = 'ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: ' + (e.error && e.error.message ? e.error.message : (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    });

    // ========================= ê³ ì • ë¡œì§ =========================
    var LABEL = { ATK:'ê³µ', CRIT:'ì¹˜í”¼', FINAL:'ìµœí”¼', ELEM:'ëª¨ì†ê°•', AFFIN:'ìƒê°•' };

    function growthPercent(level){
      return (1/6) * level*level + 171.5 * level + 2948.3333333333; // L=1:3120, L=2:3292, L=5:3810
    }
    function levelCap(awaken){ return 150 + 50*awaken; }
    function brushCost(currentLevel){ return Math.max(0, Math.floor(1500 + 20*(currentLevel - 1))); }

    // 26ì¥ ì¹´ë“œ(ì´ë¯¸ì§€ ë¹„ìš°ë©´ í”Œë ˆì´ìŠ¤í™€ë”)
    var CARD_DB = [
      { name:'ê³ ë¸”ë¦° ì¡±ì¥',      image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'ELEM'}], awakenMax:5 },
      { name:'ë¯¸ë…¸íƒ€ìš°ë¥´ìŠ¤',     image:'', stats:[{type:'FINAL'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'í˜¼ë ¹ ì‚¬ì œ',        image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ì˜í˜¼ ë„ì‚´ì',      image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'ELEM'}], awakenMax:5 },
      { name:'ì´í”„ë¦¬íŠ¸',         image:'', stats:[{type:'ATK'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'íŠ¸ìœˆí—¤ë“œ ë¦¬ìë“œ',  image:'', stats:[{type:'CRIT'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë¸”ë™ ë“œë˜ê³¤',      image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ì˜í˜¼ ì§€ë°°ì',      image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'ì„œë¦¬ ëŠ‘ëŒ€',        image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ì˜ˆí‹° ë³´ìŠ¤',        image:'', stats:[{type:'ATK'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ì„œë¦¬ ë‚˜ë¹„ ì—¬ì™•',   image:'', stats:[{type:'FINAL'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë§¹ë… ì—¬ì™• ê±°ë¯¸',   image:'', stats:[{type:'ATK'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ì‹ ë¡ì˜ ì‚¬ìŠ´',      image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'ì¼ˆë² ë¡œìŠ¤',         image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë§ˆë²• ê³µí•™ ë“œë˜ê³¤', image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'ì—ì´ì…˜íŠ¸ ë² ì–´',    image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ê±°ëŒ€ ì„ ì¸ì¥',      image:'', stats:[{type:'CRIT'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë“œë˜ê³¤ ë¦¬ìë“œ',    image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'FINAL'}], awakenMax:5 },
      { name:'ê³ ëŒ€ ê±°ë¶',        image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'ê¸°ê°„í‹± í¬ë¦¬ì²˜',    image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'ë² í—¤ëª¨ìŠ¤',         image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'í¬ë£©ìŠ¤',           image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'FINAL'}], awakenMax:5 },
      { name:'ë¼ì¿ ìŠ¤',           image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë‚˜ì´íŠ¸ ì˜¤ë² ë¡ ',    image:'', stats:[{type:'CRIT'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë¼ì´ì§„ í…êµ¬',      image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'ë ˆì´ë”” ì°¨í˜ìŠˆ',    image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'FINAL'}], awakenMax:5 }
    ];

    // ========================= UI ë°”ì¸ë”© =========================
    var cardListEl = document.getElementById('card-list');
    var budgetEl   = document.getElementById('budget');
    var calcBtn    = document.getElementById('calcBtn');
    var resetBtn   = document.getElementById('resetBtn');
    var statusEl   = document.getElementById('status');
    var planOutput = document.getElementById('plan-output');
    var resultSection = document.getElementById('result-section');
    var usedBrushEl = document.getElementById('used-brush');
    var remainingBrushEl = document.getElementById('remaining-brush');
    var totalGainEl = document.getElementById('total-gain');
    var metaEl = document.getElementById('meta');
    var STORAGE_KEY = 'sss_calc_local_final';

    function renderCards(){
      try {
        cardListEl.innerHTML = '';
        for (var i=0; i<CARD_DB.length; i++){
          var cfg = CARD_DB[i];
          var statsHtml = '';
          for (var sIdx=0; sIdx<cfg.stats.length; sIdx++){
            var s = cfg.stats[sIdx];
            var th = sIdx===0 ? 1 : (sIdx===1 ? 3 : 5);
            statsHtml += ''+
              '<div class="p-2 bg-white rounded border">'+
                '<p class="text-xs font-semibold mb-1">'+
                  (LABEL[s.type] || 'ì—†ìŒ')+
                  ' <span class="text-gray-500 font-normal">(ê°ì„± '+th+'+)</span>'+
                '</p>'+
              '</div>';
          }
          var imgUrl = (cfg.image && cfg.image.trim()) ? cfg.image : 'https://placehold.co/320x426/eeeeee/888888?text=Image';
          var html = ''+
            '<div class="card-container bg-gray-50 border border-gray-200 rounded-lg p-3 shadow-sm relative">'+
              '<div id="imgv-'+i+'" class="block">'+
                '<img src="'+imgUrl+'" alt="'+cfg.name+'" class="w-full h-auto rounded-md mb-2 aspect-3-4">'+
                '<h4 class="font-bold text-md truncate" title="'+cfg.name+'">'+cfg.name+'</h4>'+
                '<button data-i="'+i+'" class="act-btn absolute top-2 right-2 bg-green-600 text-white text-xs font-bold py-1 px-2 rounded">í™œì„±í™”</button>'+
              '</div>'+
              '<div id="inpv-'+i+'" class="hidden">'+
                '<div class="flex items-center justify-between mb-2">'+
                  '<h4 class="font-bold text-md truncate" title="'+cfg.name+'">'+cfg.name+'</h4>'+
                  '<button data-i="'+i+'" class="deact-btn text-xs px-2 py-1 rounded border">ë¹„í™œì„±í™”</button>'+
                '</div>'+
                '<div class="grid grid-cols-2 gap-2 text-sm mb-3">'+
                  '<label class="block">í˜„ì¬ ë ˆë²¨'+
                    '<input id="lv-'+i+'" type="number" min="0" value="0" class="w-full p-1 border rounded">'+
                  '</label>'+
                  '<label class="block">ê°ì„±'+
                    '<select id="aw-'+i+'" class="w-full p-1 border rounded">'+
                      (function(){var opt=''; for(var k=0;k<=5;k++){opt+='<option value="'+k+'">'+k+'</option>';} return opt;})()+
                    '</select>'+
                  '</label>'+
                '</div>'+
                '<div class="grid grid-cols-3 gap-2">'+statsHtml+'</div>'+
              '</div>'+
            '</div>';
          cardListEl.insertAdjacentHTML('beforeend', html);
        }
        metaEl.textContent = 'ì¹´ë“œ: '+CARD_DB.length+'ê°œ | ê°€ë¡œ 4ê°œ ë°°ì¹˜ | ë ˆë²¨ìº¡=150+50*ê°ì„± | ë¶“=1500+20*(Lv-1)';
        // ì¹´ë“œê°€ ì‹¤ì œë¡œ ë“¤ì–´ê°”ëŠ”ì§€ ìˆ«ìë„ statusì— ê°€ë³ê²Œ ì°ìŒ
        statusEl.textContent = 'ì¹´ë“œ ë¡œë“œ: '+CARD_DB.length+'ê°œ';
      } catch (e) {
        statusEl.classList.add('status-error');
        statusEl.textContent = 'ì¹´ë“œ ë Œë”ë§ ì˜¤ë¥˜: '+e.message;
      }
    }

    function toggleCard(i, active){
      var imgv = document.getElementById('imgv-'+i);
      var inpv = document.getElementById('inpv-'+i);
      if (!imgv || !inpv) return;
      if (active) { imgv.classList.add('hidden'); inpv.classList.remove('hidden'); }
      else { imgv.classList.remove('hidden'); inpv.classList.add('hidden'); }
    }

    cardListEl.addEventListener('click', function(e){
      var t = e.target;
      if (t && t.classList.contains('act-btn')) {
        var i = parseInt(t.getAttribute('data-i'),10);
        toggleCard(i, true);
        var lv = document.getElementById('lv-'+i);
        var aw = document.getElementById('aw-'+i);
        if (lv && parseInt(lv.value,10) === 0) lv.value = '1';
        if (aw) aw.value = '1';
        saveLocal();
      }
      if (t && t.classList.contains('deact-btn')) {
        var i2 = parseInt(t.getAttribute('data-i'),10);
        toggleCard(i2, false);
        var lv2 = document.getElementById('lv-'+i2);
        var aw2 = document.getElementById('aw-'+i2);
        if (lv2) lv2.value = '0';
        if (aw2) aw2.value = '0';
        saveLocal();
      }
    });

    function saveLocal(){
      try{
        var cards = [];
        for (var i=0;i<CARD_DB.length;i++){
          var active = !(document.getElementById('inpv-'+i).classList.contains('hidden'));
          var lv = parseInt((document.getElementById('lv-'+i) || {}).value || '0', 10);
          var aw = parseInt((document.getElementById('aw-'+i) || {}).value || '0', 10);
          cards.push({ active: active, level: isNaN(lv)?0:lv, awaken: isNaN(aw)?0:aw });
        }
        var data = { budget: budgetEl.value, cards: cards };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }catch(e){
        statusEl.classList.add('status-error');
        statusEl.textContent = 'ì €ì¥ ì˜¤ë¥˜: '+e.message;
      }
    }

    function loadLocal(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        var data = JSON.parse(raw);
        budgetEl.value = data.budget || '100000';
        for (var i=0;i<(data.cards||[]).length;i++){
          if (data.cards[i].active) toggleCard(i, true);
          var lv = document.getElementById('lv-'+i);
          var aw = document.getElementById('aw-'+i);
          if (lv) lv.value = data.cards[i].level || 0;
          if (aw) aw.value = data.cards[i].awaken || 0;
        }
      }catch(e){
        statusEl.classList.add('status-error');
        statusEl.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: '+e.message;
      }
    }

    function productAtState(state){
      var sum = { ATK:0, CRIT:0, FINAL:0, ELEM:0, AFFIN:0 };
      for (var idx=0; idx<state.length; idx++){
        var s = state[idx];
        if (s.level <= 0) continue;
        var cfg = null;
        for (var c=0;c<CARD_DB.length;c++){ if (CARD_DB[c].name === s.name){ cfg = CARD_DB[c]; break; } }
        if (!cfg) continue;

        var enabled = [];
        if (s.awaken >= 1 && cfg.stats[0]) enabled.push(cfg.stats[0].type);
        if (s.awaken >= 3 && cfg.stats[1]) enabled.push(cfg.stats[1].type);
        if (s.awaken >= 5 && cfg.stats[2]) enabled.push(cfg.stats[2].type);

        var val = growthPercent(s.level);
        for (var e=0;e<enabled.length;e++){
          var t = enabled[e];
          if (t==='ATK')   sum.ATK   += val;
          if (t==='CRIT')  sum.CRIT  += val;
          if (t==='FINAL') sum.FINAL += val;
          if (t==='ELEM')  sum.ELEM  += val;
          if (t==='AFFIN') sum.AFFIN += val;
        }
      }
      return (1 + sum.ATK/100) * (1 + sum.CRIT/100) * (1 + sum.FINAL/100) * (1 + sum.ELEM/100) * (1 + sum.AFFIN/100);
    }

    function runCalculation(){
      saveLocal();
      var initialBudget = parseInt(budgetEl.value || '0', 10) || 0;
      var budgetLeft = initialBudget;

      var act = [];
      for (var i=0;i<CARD_DB.length;i++){
        var active = !(document.getElementById('inpv-'+i).classList.contains('hidden'));
        if (!active) continue;
        var level = parseInt((document.getElementById('lv-'+i) || {}).value || '0', 10) || 0;
        var awaken = parseInt((document.getElementById('aw-'+i) || {}).value || '0', 10) || 0;
        if (level <= 0) continue;
        act.push({ name: CARD_DB[i].name, level: level, awaken: awaken, cap: levelCap(awaken) });
      }

      if (act.length === 0) {
        statusEl.classList.add('status-error');
        statusEl.textContent = 'í™œì„±í™”ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      } else {
        statusEl.classList.remove('status-error');
        statusEl.textContent = 'ê³„ì‚° ì¤‘â€¦';
      }

      var currentState = [];
      for (var a=0;a<act.length;a++) currentState.push({name:act[a].name, level:act[a].level, awaken:act[a].awaken, cap:act[a].cap});
      var currentProduct = productAtState(currentState);

      var steps = [];
      var guard = 100000;

      while (budgetLeft > 0 && guard-- > 0) {
        var bestIdx = -1, bestROI = 0, bestCost = 0, bestNextProd = 0;
        for (var j=0;j<currentState.length;j++){
          var s = currentState[j];
          if (s.level >= s.cap) continue;
          var cost = brushCost(s.level);
          if (cost > budgetLeft) continue;

          var nextState = [];
          for (var ns=0;ns<currentState.length;ns++){
            nextState.push(ns===j ? {name:currentState[ns].name, level:currentState[ns].level+1, awaken:currentState[ns].awaken, cap:currentState[ns].cap}
                                  : {name:currentState[ns].name, level:currentState[ns].level,   awaken:currentState[ns].awaken, cap:currentState[ns].cap});
          }
          var nextProd = productAtState(nextState);
          var roi = (nextProd - currentProduct) / cost;
          if (roi > bestROI) { bestROI = roi; bestIdx = j; bestCost = cost; bestNextProd = nextProd; }
        }
        if (bestIdx === -1 || bestROI <= 0) break;

        currentState[bestIdx].level += 1;
        budgetLeft -= bestCost;
        steps.push({ name: currentState[bestIdx].name, to: currentState[bestIdx].level, cost: bestCost, roi: bestROI });
        currentProduct = bestNextProd;
      }

      var html = '';
      if (steps.length === 0) {
        html = '<p>ë ˆë²¨ì—… í•  ì¹´ë“œê°€ ì—†ê±°ë‚˜ ì˜ˆì‚°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>';
      } else {
        html = '<ol class="list-decimal pl-5 space-y-1">';
        for (var k=0;k<steps.length;k++){
          var s2 = steps[k];
          html += '<li><strong>'+s2.name+'</strong> â†’ <span class="text-emerald-700 font-semibold">Lv.'+s2.to+
                  '</span> <span class="text-xs text-gray-500">(ë¶“ '+(s2.cost.toLocaleString())+'ê°œ, ROI '+(s2.roi*100).toFixed(4)+'%)</span></li>';
        }
        html += '</ol>';
      }
      planOutput.innerHTML = html;

      var initialProduct = productAtState(act);
      var totalGain = initialProduct > 0 ? ((currentProduct/initialProduct - 1) * 100) : 0;

      usedBrushEl.textContent = (initialBudget - budgetLeft).toLocaleString();
      remainingBrushEl.textContent = budgetLeft.toLocaleString();
      totalGainEl.textContent = (totalGain||0).toFixed(4) + '%';

      resultSection.classList.remove('hidden');
      statusEl.textContent = steps.length ? 'ê³„ì‚° ì™„ë£Œ' : 'ì¶”ê°€ë¡œ íš¨ìœ¨ì ì¸ ë ˆë²¨ì—…ì´ ì—†ìŠµë‹ˆë‹¤.';
    }

    // ë²„íŠ¼ ë°”ì¸ë”©
    document.getElementById('calcBtn').addEventListener('click', runCalculation);
    document.getElementById('resetBtn').addEventListener('click', function(){
      if (!confirm('ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
      budgetEl.value = '100000';
      for (var i=0;i<CARD_DB.length;i++){
        toggleCard(i,false);
        var lv=document.getElementById('lv-'+i); if(lv) lv.value=0;
        var aw=document.getElementById('aw-'+i); if(aw) aw.value=0;
      }
      resultSection.classList.add('hidden');
    });

    // ===== ì¦‰ì‹œ ì´ˆê¸°í™” (DOMContentLoaded ì•ˆ ì”€) =====
    (function init(){
      renderCards();
      loadLocal();
    })();
  </script>
</body>
</html>
