<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSS급 붓 효율 계산기 (내장 2차성장)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', system-ui, -apple-system, "Segoe UI", Arial, sans-serif; }
    .card-container { transition: all .2s ease; }
    .card-container:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .aspect-3-4 { aspect-ratio: 3/4; object-fit: cover; }
    .status-error { background:#fff1f2; color:#991b1b; border:1px solid #fecaca; padding:.5rem .75rem; border-radius:.5rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold">SSS급 붓 효율 계산기</h1>
      <p class="text-gray-600 mt-2">시트 없이, 코드에 내장된 <b>정확 재현 2차식</b> 성장 로직으로 계산합니다.</p>
    </header>

    <!-- 설정 -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-3 border-b pb-2">기본 설정</h2>
      <div class="flex flex-col md:flex-row gap-4 md:items-end md:gap-6">
        <div>
          <label class="block text-sm mb-1" for="budget">보유 붓 개수</label>
          <input id="budget" type="number" value="100000" class="w-40 p-2 border rounded-md">
        </div>
        <div class="flex gap-2">
          <button id="calcBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">계산 시작</button>
          <button id="resetBtn" class="bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600">전체 초기화</button>
        </div>
      </div>
      <p id="status" class="mt-3 text-sm text-gray-600">카드를 활성화하고 레벨/각성을 선택한 뒤 [계산 시작]을 누르세요.</p>
    </section>

    <!-- 카드 -->
    <section class="bg-white p-6 rounded-xl shadow-md mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">카드 정보</h2>
        <span id="meta" class="text-xs px-2 py-1 border rounded text-gray-600">-</span>
      </div>
      <!-- 가로 4개 고정 -->
      <div id="card-list" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- 결과 -->
    <section id="result-section" class="bg-white p-6 rounded-xl shadow-md hidden">
      <h2 class="text-xl font-semibold mb-3 border-b pb-2">계산 결과</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-2 text-indigo-700">📈 렙업 계획</h3>
          <div id="plan-output" class="h-72 overflow-y-auto bg-gray-50 p-3 rounded-md border"></div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2 text-indigo-700">📊 최종 요약</h3>
          <div class="space-y-1 text-sm">
            <p><strong>- 사용한 붓:</strong> <span id="used-brush">0</span>개</p>
            <p><strong>- 남은 붓:</strong> <span id="remaining-brush">0</span>개</p>
            <p><strong>- 총 효율 상승:</strong> <span id="total-gain" class="font-bold text-green-600">0.00%</span></p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // 전역 에러를 상태창에 표시
    window.addEventListener('error', function(e){
      var st = document.getElementById('status');
      if (st) {
        st.classList.add('status-error');
        st.textContent = '스크립트 오류: ' + (e.error && e.error.message ? e.error.message : (e.message || '알 수 없는 오류'));
      }
    });

    // ========================= 고정 로직 =========================
    var LABEL = { ATK:'공', CRIT:'치피', FINAL:'최피', ELEM:'모속강', AFFIN:'상강' };

    function growthPercent(level){
      return (1/6) * level*level + 171.5 * level + 2948.3333333333; // L=1:3120, L=2:3292, L=5:3810
    }
    function levelCap(awaken){ return 150 + 50*awaken; }
    function brushCost(currentLevel){ return Math.max(0, Math.floor(1500 + 20*(currentLevel - 1))); }

    // 26장 카드(이미지 비우면 플레이스홀더)
    var CARD_DB = [
      { name:'고블린 족장',      image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'ELEM'}], awakenMax:5 },
      { name:'미노타우르스',     image:'', stats:[{type:'FINAL'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'혼령 사제',        image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'AFFIN'}], awakenMax:5 },
      { name:'영혼 도살자',      image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'ELEM'}], awakenMax:5 },
      { name:'이프리트',         image:'', stats:[{type:'ATK'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'트윈헤드 리자드',  image:'', stats:[{type:'CRIT'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'블랙 드래곤',      image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'AFFIN'}], awakenMax:5 },
      { name:'영혼 지배자',      image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'서리 늑대',        image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'예티 보스',        image:'', stats:[{type:'ATK'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'서리 나비 여왕',   image:'', stats:[{type:'FINAL'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'맹독 여왕 거미',   image:'', stats:[{type:'ATK'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'신록의 사슴',      image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'켈베로스',         image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'마법 공학 드래곤', image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'에이션트 베어',    image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'AFFIN'}], awakenMax:5 },
      { name:'거대 선인장',      image:'', stats:[{type:'CRIT'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'드래곤 리자드',    image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'FINAL'}], awakenMax:5 },
      { name:'고대 거북',        image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'기간틱 크리처',    image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'ELEM'}], awakenMax:5 },
      { name:'베헤모스',         image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'크룩스',           image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'FINAL'}], awakenMax:5 },
      { name:'라쿠스',           image:'', stats:[{type:'CRIT'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'나이트 오베론',    image:'', stats:[{type:'CRIT'},{type:'ELEM'},{type:'AFFIN'}], awakenMax:5 },
      { name:'라이진 텐구',      image:'', stats:[{type:'ATK'},{type:'FINAL'},{type:'AFFIN'}], awakenMax:5 },
      { name:'레이디 차페슈',    image:'', stats:[{type:'ATK'},{type:'CRIT'},{type:'FINAL'}], awakenMax:5 }
    ];

    // ========================= UI 바인딩 =========================
    var cardListEl = document.getElementById('card-list');
    var budgetEl   = document.getElementById('budget');
    var calcBtn    = document.getElementById('calcBtn');
    var resetBtn   = document.getElementById('resetBtn');
    var statusEl   = document.getElementById('status');
    var planOutput = document.getElementById('plan-output');
    var resultSection = document.getElementById('result-section');
    var usedBrushEl = document.getElementById('used-brush');
    var remainingBrushEl = document.getElementById('remaining-brush');
    var totalGainEl = document.getElementById('total-gain');
    var metaEl = document.getElementById('meta');
    var STORAGE_KEY = 'sss_calc_local_final';

    function renderCards(){
      try {
        cardListEl.innerHTML = '';
        for (var i=0; i<CARD_DB.length; i++){
          var cfg = CARD_DB[i];
          var statsHtml = '';
          for (var sIdx=0; sIdx<cfg.stats.length; sIdx++){
            var s = cfg.stats[sIdx];
            var th = sIdx===0 ? 1 : (sIdx===1 ? 3 : 5);
            statsHtml += ''+
              '<div class="p-2 bg-white rounded border">'+
                '<p class="text-xs font-semibold mb-1">'+
                  (LABEL[s.type] || '없음')+
                  ' <span class="text-gray-500 font-normal">(각성 '+th+'+)</span>'+
                '</p>'+
              '</div>';
          }
          var imgUrl = (cfg.image && cfg.image.trim()) ? cfg.image : 'https://placehold.co/320x426/eeeeee/888888?text=Image';
          var html = ''+
            '<div class="card-container bg-gray-50 border border-gray-200 rounded-lg p-3 shadow-sm relative">'+
              '<div id="imgv-'+i+'" class="block">'+
                '<img src="'+imgUrl+'" alt="'+cfg.name+'" class="w-full h-auto rounded-md mb-2 aspect-3-4">'+
                '<h4 class="font-bold text-md truncate" title="'+cfg.name+'">'+cfg.name+'</h4>'+
                '<button data-i="'+i+'" class="act-btn absolute top-2 right-2 bg-green-600 text-white text-xs font-bold py-1 px-2 rounded">활성화</button>'+
              '</div>'+
              '<div id="inpv-'+i+'" class="hidden">'+
                '<div class="flex items-center justify-between mb-2">'+
                  '<h4 class="font-bold text-md truncate" title="'+cfg.name+'">'+cfg.name+'</h4>'+
                  '<button data-i="'+i+'" class="deact-btn text-xs px-2 py-1 rounded border">비활성화</button>'+
                '</div>'+
                '<div class="grid grid-cols-2 gap-2 text-sm mb-3">'+
                  '<label class="block">현재 레벨'+
                    '<input id="lv-'+i+'" type="number" min="0" value="0" class="w-full p-1 border rounded">'+
                  '</label>'+
                  '<label class="block">각성'+
                    '<select id="aw-'+i+'" class="w-full p-1 border rounded">'+
                      (function(){var opt=''; for(var k=0;k<=5;k++){opt+='<option value="'+k+'">'+k+'</option>';} return opt;})()+
                    '</select>'+
                  '</label>'+
                '</div>'+
                '<div class="grid grid-cols-3 gap-2">'+statsHtml+'</div>'+
              '</div>'+
            '</div>';
          cardListEl.insertAdjacentHTML('beforeend', html);
        }
        metaEl.textContent = '카드: '+CARD_DB.length+'개 | 가로 4개 배치 | 레벨캡=150+50*각성 | 붓=1500+20*(Lv-1)';
        // 카드가 실제로 들어갔는지 숫자도 status에 가볍게 찍음
        statusEl.textContent = '카드 로드: '+CARD_DB.length+'개';
      } catch (e) {
        statusEl.classList.add('status-error');
        statusEl.textContent = '카드 렌더링 오류: '+e.message;
      }
    }

    function toggleCard(i, active){
      var imgv = document.getElementById('imgv-'+i);
      var inpv = document.getElementById('inpv-'+i);
      if (!imgv || !inpv) return;
      if (active) { imgv.classList.add('hidden'); inpv.classList.remove('hidden'); }
      else { imgv.classList.remove('hidden'); inpv.classList.add('hidden'); }
    }

    cardListEl.addEventListener('click', function(e){
      var t = e.target;
      if (t && t.classList.contains('act-btn')) {
        var i = parseInt(t.getAttribute('data-i'),10);
        toggleCard(i, true);
        var lv = document.getElementById('lv-'+i);
        var aw = document.getElementById('aw-'+i);
        if (lv && parseInt(lv.value,10) === 0) lv.value = '1';
        if (aw) aw.value = '1';
        saveLocal();
      }
      if (t && t.classList.contains('deact-btn')) {
        var i2 = parseInt(t.getAttribute('data-i'),10);
        toggleCard(i2, false);
        var lv2 = document.getElementById('lv-'+i2);
        var aw2 = document.getElementById('aw-'+i2);
        if (lv2) lv2.value = '0';
        if (aw2) aw2.value = '0';
        saveLocal();
      }
    });

    function saveLocal(){
      try{
        var cards = [];
        for (var i=0;i<CARD_DB.length;i++){
          var active = !(document.getElementById('inpv-'+i).classList.contains('hidden'));
          var lv = parseInt((document.getElementById('lv-'+i) || {}).value || '0', 10);
          var aw = parseInt((document.getElementById('aw-'+i) || {}).value || '0', 10);
          cards.push({ active: active, level: isNaN(lv)?0:lv, awaken: isNaN(aw)?0:aw });
        }
        var data = { budget: budgetEl.value, cards: cards };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }catch(e){
        statusEl.classList.add('status-error');
        statusEl.textContent = '저장 오류: '+e.message;
      }
    }

    function loadLocal(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        var data = JSON.parse(raw);
        budgetEl.value = data.budget || '100000';
        for (var i=0;i<(data.cards||[]).length;i++){
          if (data.cards[i].active) toggleCard(i, true);
          var lv = document.getElementById('lv-'+i);
          var aw = document.getElementById('aw-'+i);
          if (lv) lv.value = data.cards[i].level || 0;
          if (aw) aw.value = data.cards[i].awaken || 0;
        }
      }catch(e){
        statusEl.classList.add('status-error');
        statusEl.textContent = '불러오기 오류: '+e.message;
      }
    }

    function productAtState(state){
      var sum = { ATK:0, CRIT:0, FINAL:0, ELEM:0, AFFIN:0 };
      for (var idx=0; idx<state.length; idx++){
        var s = state[idx];
        if (s.level <= 0) continue;
        var cfg = null;
        for (var c=0;c<CARD_DB.length;c++){ if (CARD_DB[c].name === s.name){ cfg = CARD_DB[c]; break; } }
        if (!cfg) continue;

        var enabled = [];
        if (s.awaken >= 1 && cfg.stats[0]) enabled.push(cfg.stats[0].type);
        if (s.awaken >= 3 && cfg.stats[1]) enabled.push(cfg.stats[1].type);
        if (s.awaken >= 5 && cfg.stats[2]) enabled.push(cfg.stats[2].type);

        var val = growthPercent(s.level);
        for (var e=0;e<enabled.length;e++){
          var t = enabled[e];
          if (t==='ATK')   sum.ATK   += val;
          if (t==='CRIT')  sum.CRIT  += val;
          if (t==='FINAL') sum.FINAL += val;
          if (t==='ELEM')  sum.ELEM  += val;
          if (t==='AFFIN') sum.AFFIN += val;
        }
      }
      return (1 + sum.ATK/100) * (1 + sum.CRIT/100) * (1 + sum.FINAL/100) * (1 + sum.ELEM/100) * (1 + sum.AFFIN/100);
    }

    function runCalculation(){
      saveLocal();
      var initialBudget = parseInt(budgetEl.value || '0', 10) || 0;
      var budgetLeft = initialBudget;

      var act = [];
      for (var i=0;i<CARD_DB.length;i++){
        var active = !(document.getElementById('inpv-'+i).classList.contains('hidden'));
        if (!active) continue;
        var level = parseInt((document.getElementById('lv-'+i) || {}).value || '0', 10) || 0;
        var awaken = parseInt((document.getElementById('aw-'+i) || {}).value || '0', 10) || 0;
        if (level <= 0) continue;
        act.push({ name: CARD_DB[i].name, level: level, awaken: awaken, cap: levelCap(awaken) });
      }

      if (act.length === 0) {
        statusEl.classList.add('status-error');
        statusEl.textContent = '활성화된 카드가 없습니다.';
        return;
      } else {
        statusEl.classList.remove('status-error');
        statusEl.textContent = '계산 중…';
      }

      var currentState = [];
      for (var a=0;a<act.length;a++) currentState.push({name:act[a].name, level:act[a].level, awaken:act[a].awaken, cap:act[a].cap});
      var currentProduct = productAtState(currentState);

      var steps = [];
      var guard = 100000;

      while (budgetLeft > 0 && guard-- > 0) {
        var bestIdx = -1, bestROI = 0, bestCost = 0, bestNextProd = 0;
        for (var j=0;j<currentState.length;j++){
          var s = currentState[j];
          if (s.level >= s.cap) continue;
          var cost = brushCost(s.level);
          if (cost > budgetLeft) continue;

          var nextState = [];
          for (var ns=0;ns<currentState.length;ns++){
            nextState.push(ns===j ? {name:currentState[ns].name, level:currentState[ns].level+1, awaken:currentState[ns].awaken, cap:currentState[ns].cap}
                                  : {name:currentState[ns].name, level:currentState[ns].level,   awaken:currentState[ns].awaken, cap:currentState[ns].cap});
          }
          var nextProd = productAtState(nextState);
          var roi = (nextProd - currentProduct) / cost;
          if (roi > bestROI) { bestROI = roi; bestIdx = j; bestCost = cost; bestNextProd = nextProd; }
        }
        if (bestIdx === -1 || bestROI <= 0) break;

        currentState[bestIdx].level += 1;
        budgetLeft -= bestCost;
        steps.push({ name: currentState[bestIdx].name, to: currentState[bestIdx].level, cost: bestCost, roi: bestROI });
        currentProduct = bestNextProd;
      }

      var html = '';
      if (steps.length === 0) {
        html = '<p>레벨업 할 카드가 없거나 예산이 부족합니다.</p>';
      } else {
        html = '<ol class="list-decimal pl-5 space-y-1">';
        for (var k=0;k<steps.length;k++){
          var s2 = steps[k];
          html += '<li><strong>'+s2.name+'</strong> → <span class="text-emerald-700 font-semibold">Lv.'+s2.to+
                  '</span> <span class="text-xs text-gray-500">(붓 '+(s2.cost.toLocaleString())+'개, ROI '+(s2.roi*100).toFixed(4)+'%)</span></li>';
        }
        html += '</ol>';
      }
      planOutput.innerHTML = html;

      var initialProduct = productAtState(act);
      var totalGain = initialProduct > 0 ? ((currentProduct/initialProduct - 1) * 100) : 0;

      usedBrushEl.textContent = (initialBudget - budgetLeft).toLocaleString();
      remainingBrushEl.textContent = budgetLeft.toLocaleString();
      totalGainEl.textContent = (totalGain||0).toFixed(4) + '%';

      resultSection.classList.remove('hidden');
      statusEl.textContent = steps.length ? '계산 완료' : '추가로 효율적인 레벨업이 없습니다.';
    }

    // 버튼 바인딩
    document.getElementById('calcBtn').addEventListener('click', runCalculation);
    document.getElementById('resetBtn').addEventListener('click', function(){
      if (!confirm('모든 입력을 초기화할까요?')) return;
      try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
      budgetEl.value = '100000';
      for (var i=0;i<CARD_DB.length;i++){
        toggleCard(i,false);
        var lv=document.getElementById('lv-'+i); if(lv) lv.value=0;
        var aw=document.getElementById('aw-'+i); if(aw) aw.value=0;
      }
      resultSection.classList.add('hidden');
    });

    // ===== 즉시 초기화 (DOMContentLoaded 안 씀) =====
    (function init(){
      renderCards();
      loadLocal();
    })();
  </script>
</body>
</html>
